import{A as c}from"./elements-e4cea95b.js";import"./lit-html-6ec30b87.js";import"./lit-element-e4129e81.js";import"./index-a4ad80d2.js";const d=1e3,u=1e3;class p{constructor(e={}){this.warmUpDelay=d,this.coolDownDelay=u,this.isWarm=!1,this.timeout=0,Object.assign(this,e)}async openTimer(e){if(this.cancelCooldownTimer(),!this.component||!e.isSameNode(this.component))return this.component&&(this.close(this.component),this.cancelCooldownTimer()),this.component=e,this.isWarm?!1:(this.promise=new Promise(t=>{this.resolve=t,this.timeout=window.setTimeout(()=>{this.resolve&&(this.resolve(!1),this.isWarm=!0)},this.warmUpDelay)}),this.promise);if(this.promise)return this.promise;throw new Error("Inconsistent state")}close(e){this.component&&this.component.isSameNode(e)&&(this.resetCooldownTimer(),this.timeout>0&&(clearTimeout(this.timeout),this.timeout=0),this.resolve&&(this.resolve(!0),delete this.resolve),delete this.promise,delete this.component)}resetCooldownTimer(){this.isWarm&&(this.cooldownTimeout&&window.clearTimeout(this.cooldownTimeout),this.cooldownTimeout=window.setTimeout(()=>{this.isWarm=!1,delete this.cooldownTimeout},this.coolDownDelay))}cancelCooldownTimer(){this.cooldownTimeout&&window.clearTimeout(this.cooldownTimeout),delete this.cooldownTimeout}}function m(s){return s.button===0}function f(s){return!!(s.metaKey||s.altKey||s.ctrlKey||s.shiftKey)}class y{constructor(){this.overlays=[],this.preventMouseRootClose=!1,this.root=document.body,this.handlingResize=!1,this.overlayTimer=new p,this.canTabTrap=!0,this.trappingInited=!1,this.handleMouseCapture=e=>{const t=this.topOverlay;if(!e.target||!t||!t.overlayContent||f(e)||!m(e)){this.preventMouseRootClose=!0;return}if(e.target instanceof Node){if(e.composedPath().indexOf(t.overlayContent)>=0){this.preventMouseRootClose=!0;return}this.preventMouseRootClose=!1}},this.handleMouse=()=>{this.preventMouseRootClose||this.closeTopOverlay()},this.handleKeyUp=e=>{if(e.code==="Escape"){const t=this.topOverlay;this.closeTopOverlay(),t&&t.trigger.focus()}},this.handleResize=()=>{this.handlingResize||(this.handlingResize=!0,requestAnimationFrame(async()=>{const e=this.overlays.map(t=>t.updateOverlayPosition());await Promise.all(e),this.handlingResize=!1}))},this.addEventListeners()}initTabTrapping(){if(this.document.body.shadowRoot){this.canTabTrap=!1;return}if(this.document.body.attachShadow({mode:"open"}),!this.document.body.shadowRoot)return;const e=this.document.body.shadowRoot;e.innerHTML=`
            <div id="actual"><slot></slot></div>
            <style>
            #actual {
                position: relative;
                height: 100%;
                z-index: 0;
                min-height: 100vh;
            }
            #holder {
                display: flex;
                align-items: center;
                justify-content: center;
                flex-flow: column;
                height: 100%;
                width: 100%;
                top: 0;
                left: 0;
                position: fixed;
            }
            #holder[hidden] {
                display: none !important;
            }
            #actual[tabindex="-1"] {
                pointer-events: none;  /* just in case? */
            }
            </style>
            <div id="holder" hidden><slot name="open"></slot></div>
        `,this.tabTrapper=e.querySelector("#actual"),this.overlayHolder=e.querySelector("#holder"),this.tabTrapper.attachShadow({mode:"open"}),this.tabTrapper.shadowRoot&&(this.tabTrapper.shadowRoot.innerHTML="<slot></slot>")}startTabTrapping(){this.trappingInited||(this.initTabTrapping(),this.trappingInited=!0),!!this.canTabTrap&&(this.tabTrapper.tabIndex=-1,this.overlayHolder.hidden=!1)}stopTabTrapping(){!this.canTabTrap||!this.trappingInited||(this.tabTrapper.removeAttribute("tabindex"),this.overlayHolder.hidden=!0)}get document(){return this.root.ownerDocument||document}get topOverlay(){return this.overlays.slice(-1)[0]}findOverlayForContent(e){for(const t of this.overlays)if(e.isSameNode(t.overlayContent))return t}addEventListeners(){this.document.addEventListener("click",this.handleMouseCapture,!0),this.document.addEventListener("click",this.handleMouse),this.document.addEventListener("keyup",this.handleKeyUp),window.addEventListener("resize",this.handleResize)}isClickOverlayActiveForTrigger(e){return this.overlays.some(t=>e.isSameNode(t.trigger)&&t.interaction==="click")}async openOverlay(e){if(this.findOverlayForContent(e.content))return!1;if(e.interaction==="modal"&&this.startTabTrapping(),e.delayed){const o=this.overlayTimer.openTimer(e.content);if(await o)return o}if(e.interaction==="click")this.closeAllHoverOverlays();else if(e.interaction==="hover"&&this.isClickOverlayActiveForTrigger(e.trigger))return!0;this.overlays.length&&this.overlays[this.overlays.length-1].obscure();const t=c.create(e);return document.body.appendChild(t),new Promise(o=>requestAnimationFrame(o)).then(async()=>(this.overlays.push(t),await t.updateComplete,this.addOverlayEventListeners(t),e.receivesFocus==="auto"&&t.focus(),e.trigger.dispatchEvent(new CustomEvent("sp-opened",{bubbles:!0,composed:!0,cancelable:!0,detail:{interaction:e.interaction}})),!1))}addOverlayEventListeners(e){switch(e.addEventListener("close",()=>{this.hideAndCloseOverlay(e)}),e.interaction){case"replace":this.addReplaceOverlayEventListeners(e);break;case"inline":this.addInlineOverlayEventListeners(e);break}}addReplaceOverlayEventListeners(e){e.addEventListener("keydown",t=>{const{code:o}=t;o==="Tab"&&(t.stopPropagation(),this.closeOverlay(e.overlayContent),e.tabbingAway=!0,e.trigger.focus(),e.trigger.dispatchEvent(new KeyboardEvent("keydown",t)))})}addInlineOverlayEventListeners(e){e.returnFocusElement||(e.returnFocusElement=document.createElement("span"),e.returnFocusElement.tabIndex=-1,e.trigger.hasAttribute("slot")&&(e.returnFocusElement.slot=e.trigger.slot),e.trigger.insertAdjacentElement("afterend",e.returnFocusElement)),e.trigger.addEventListener("keydown",e.handleInlineTriggerKeydown),e.addEventListener("keydown",t=>{const{code:o,shiftKey:i}=t;if(o==="Tab"){if(e.tabbingAway=!0,i&&e.returnFocusElement){e.returnFocusElement.focus();return}t.stopPropagation(),this.closeOverlay(e.overlayContent),e.trigger.focus()}})}closeOverlay(e){this.overlayTimer.close(e),requestAnimationFrame(()=>{const t=this.findOverlayForContent(e);this.hideAndCloseOverlay(t)})}closeAllHoverOverlays(){for(const e of this.overlays)e.interaction==="hover"&&this.hideAndCloseOverlay(e,!1)}async hideAndCloseOverlay(e,t){if(e){if(await e.hide(t),e.state!="dispose")return;const o=this.overlays.indexOf(e);if(o>=0&&this.overlays.splice(o,1),this.overlays.length){const i=this.overlays[this.overlays.length-1];i.feature(),i.interaction==="modal"?i.focus():this.stopTabTrapping()}else{if(this.stopTabTrapping(),e.interaction==="modal"||(e.interaction==="replace"||e.interaction==="inline")&&!e.tabbingAway){const n=e.overlayContent.getRootNode().activeElement,l=e.trigger.getRootNode(),r=l.activeElement;(e.overlayContent.contains(n)||e.trigger.getRootNode().contains(r)||l.host&&l.host.isSameNode(r))&&e.trigger.focus()}e.tabbingAway=!1}e.remove(),e.dispose(),e.trigger.dispatchEvent(new CustomEvent("sp-closed",{bubbles:!0,composed:!0,cancelable:!0,detail:{interaction:e.interaction}}))}}closeTopOverlay(){return this.hideAndCloseOverlay(this.topOverlay)}}class a{constructor(e,t,o){this.isOpen=!1,this.owner=e,this.overlayElement=o,this.interaction=t}static async open(e,t,o,i){const n=new a(e,t,o);return await n.open(i),()=>{n.close()}}static update(){const e=new CustomEvent("sp-update-overlays",{bubbles:!0,composed:!0,cancelable:!0});document.dispatchEvent(e)}async open({delayed:e,offset:t=0,placement:o="top",receivesFocus:i}){if(this.isOpen)return!0;e===void 0&&(e=this.overlayElement.hasAttribute("delayed"));const n={color:void 0,scale:void 0},l=new CustomEvent("sp-query-theme",{bubbles:!0,composed:!0,detail:n,cancelable:!0});this.owner.dispatchEvent(l);const r={},h=new CustomEvent("sp-overlay-query",{bubbles:!0,composed:!0,detail:r,cancelable:!0});return this.overlayElement.dispatchEvent(h),await a.overlayStack.openOverlay(Object.assign({content:this.overlayElement,contentTip:r.overlayContentTipElement,delayed:e,offset:t,placement:o,trigger:this.owner,interaction:this.interaction,theme:n,receivesFocus:i},r)),this.isOpen=!0,!0}close(){a.overlayStack.closeOverlay(this.overlayElement)}}a.overlayStack=new y;export{a as Overlay};
