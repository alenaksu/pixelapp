import i from"../../Filter.js";import{createFramebuffer as l}from"../../utils.js";import u from"./shader.js";export default class s extends i{constructor(...e){super(...e);this.name="Palette",this.paletteTexture=null,this.parameters={paletteSize:0,ditherMatrix:[[1,48,12,60,3,51,15,63],[32,16,44,28,35,19,47,31],[8,56,4,52,11,59,7,55],[40,24,36,20,43,27,39,23],[2,50,14,62,1,49,13,61],[34,18,46,30,33,17,45,29],[10,58,6,54,9,57,5,53],[42,26,38,22,41,25,37,21]].flat().map(t=>(t+1)/64-.5),ditherThreshold:0,ditherSize:1}}static get fragmentShader(){return u}setPalette(e){if(e){const t=this.gl,r=l(t,256,1);t.bindFramebuffer(t.FRAMEBUFFER,r.buffer),t.bindTexture(t.TEXTURE_2D,r.texture),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e),t.bindTexture(t.TEXTURE_2D,null),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(r.buffer),this.parameters.paletteSize=e.width,this.paletteTexture=r.texture}else this.parameters.paletteSize=0,this.paletteTexture=null}use(){const{gl:e,paletteTexture:t,program:r}=this;if(!t)return;super.use(),e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,t),e.activeTexture(e.TEXTURE0);const a=e.getUniformLocation(r,"palette");e.uniform1i(a,2)}clear(){const{gl:e}=this;e.activeTexture(e.TEXTURE2),e.bindTexture(e.TEXTURE_2D,null),e.activeTexture(e.TEXTURE0)}}
