function S(i,e,r,n){var t=y();if(n)for(var a=0;a<n.length;a++)t=n[a](t);var s=e(function(d){t.initializeInstanceElements(d,o.elements)},r),o=t.decorateClass(D(s.d.map(T)),i);return t.initializeClassElements(s.F,o.elements),t.runClassFinishers(s.F,o.finishers)}function y(){y=function(){return i};var i={elementsDefinitionOrder:[["method"],["field"]],initializeInstanceElements:function(e,r){["method","field"].forEach(function(n){r.forEach(function(t){t.kind===n&&t.placement==="own"&&this.defineClassElement(e,t)},this)},this)},initializeClassElements:function(e,r){var n=e.prototype;["method","field"].forEach(function(t){r.forEach(function(a){var s=a.placement;if(a.kind===t&&(s==="static"||s==="prototype")){var o=s==="static"?e:n;this.defineClassElement(o,a)}},this)},this)},defineClassElement:function(e,r){var n=r.descriptor;if(r.kind==="field"){var t=r.initializer;n={enumerable:n.enumerable,writable:n.writable,configurable:n.configurable,value:t===void 0?void 0:t.call(e)}}Object.defineProperty(e,r.key,n)},decorateClass:function(e,r){var n=[],t=[],a={static:[],prototype:[],own:[]};if(e.forEach(function(o){this.addElementPlacement(o,a)},this),e.forEach(function(o){if(!c(o))return n.push(o);var l=this.decorateElement(o,a);n.push(l.element),n.push.apply(n,l.extras),t.push.apply(t,l.finishers)},this),!r)return{elements:n,finishers:t};var s=this.decorateConstructor(n,r);return t.push.apply(t,s.finishers),s.finishers=t,s},addElementPlacement:function(e,r,n){var t=r[e.placement];if(!n&&t.indexOf(e.key)!==-1)throw new TypeError("Duplicated element ("+e.key+")");t.push(e.key)},decorateElement:function(e,r){for(var n=[],t=[],a=e.decorators,s=a.length-1;s>=0;s--){var o=r[e.placement];o.splice(o.indexOf(e.key),1);var l=this.fromElementDescriptor(e),d=this.toElementFinisherExtras((0,a[s])(l)||l);e=d.element,this.addElementPlacement(e,r),d.finisher&&t.push(d.finisher);var p=d.extras;if(p){for(var v=0;v<p.length;v++)this.addElementPlacement(p[v],r);n.push.apply(n,p)}}return{element:e,finishers:t,extras:n}},decorateConstructor:function(e,r){for(var n=[],t=r.length-1;t>=0;t--){var a=this.fromClassDescriptor(e),s=this.toClassDescriptor((0,r[t])(a)||a);if(s.finisher!==void 0&&n.push(s.finisher),s.elements!==void 0){e=s.elements;for(var o=0;o<e.length-1;o++)for(var l=o+1;l<e.length;l++)if(e[o].key===e[l].key&&e[o].placement===e[l].placement)throw new TypeError("Duplicated element ("+e[o].key+")")}}return{elements:e,finishers:n}},fromElementDescriptor:function(e){var r={kind:e.kind,key:e.key,placement:e.placement,descriptor:e.descriptor},n={value:"Descriptor",configurable:!0};return Object.defineProperty(r,Symbol.toStringTag,n),e.kind==="field"&&(r.initializer=e.initializer),r},toElementDescriptors:function(e){return e===void 0?void 0:x(e).map(function(r){var n=this.toElementDescriptor(r);return this.disallowProperty(r,"finisher","An element descriptor"),this.disallowProperty(r,"extras","An element descriptor"),n},this)},toElementDescriptor:function(e){var r=String(e.kind);if(r!=="method"&&r!=="field")throw new TypeError(`An element descriptor's .kind property must be either "method" or "field", but a decorator created an element descriptor with .kind "`+r+'"');var n=k(e.key),t=String(e.placement);if(t!=="static"&&t!=="prototype"&&t!=="own")throw new TypeError(`An element descriptor's .placement property must be one of "static", "prototype" or "own", but a decorator created an element descriptor with .placement "`+t+'"');var a=e.descriptor;this.disallowProperty(e,"elements","An element descriptor");var s={kind:r,key:n,placement:t,descriptor:Object.assign({},a)};return r!=="field"?this.disallowProperty(e,"initializer","A method descriptor"):(this.disallowProperty(a,"get","The property descriptor of a field descriptor"),this.disallowProperty(a,"set","The property descriptor of a field descriptor"),this.disallowProperty(a,"value","The property descriptor of a field descriptor"),s.initializer=e.initializer),s},toElementFinisherExtras:function(e){var r=this.toElementDescriptor(e),n=b(e,"finisher"),t=this.toElementDescriptors(e.extras);return{element:r,finisher:n,extras:t}},fromClassDescriptor:function(e){var r={kind:"class",elements:e.map(this.fromElementDescriptor,this)},n={value:"Descriptor",configurable:!0};return Object.defineProperty(r,Symbol.toStringTag,n),r},toClassDescriptor:function(e){var r=String(e.kind);if(r!=="class")throw new TypeError(`A class descriptor's .kind property must be "class", but a decorator created a class descriptor with .kind "`+r+'"');this.disallowProperty(e,"key","A class descriptor"),this.disallowProperty(e,"placement","A class descriptor"),this.disallowProperty(e,"descriptor","A class descriptor"),this.disallowProperty(e,"initializer","A class descriptor"),this.disallowProperty(e,"extras","A class descriptor");var n=b(e,"finisher"),t=this.toElementDescriptors(e.elements);return{elements:t,finisher:n}},runClassFinishers:function(e,r){for(var n=0;n<r.length;n++){var t=(0,r[n])(e);if(t!==void 0){if(typeof t!="function")throw new TypeError("Finishers must return a constructor.");e=t}}return e},disallowProperty:function(e,r,n){if(e[r]!==void 0)throw new TypeError(n+" can't have a ."+r+" property.")}};return i}function T(i){var e=k(i.key),r;i.kind==="method"?r={value:i.value,writable:!0,configurable:!0,enumerable:!1}:i.kind==="get"?r={get:i.value,configurable:!0,enumerable:!1}:i.kind==="set"?r={set:i.value,configurable:!0,enumerable:!1}:i.kind==="field"&&(r={configurable:!0,writable:!0,enumerable:!0});var n={kind:i.kind==="field"?"field":"method",key:e,placement:i.static?"static":i.kind==="field"?"own":"prototype",descriptor:r};return i.decorators&&(n.decorators=i.decorators),i.kind==="field"&&(n.initializer=i.value),n}function O(i,e){i.descriptor.get!==void 0?e.descriptor.get=i.descriptor.get:e.descriptor.set=i.descriptor.set}function D(i){for(var e=[],r=function(s){return s.kind==="method"&&s.key===t.key&&s.placement===t.placement},n=0;n<i.length;n++){var t=i[n],a;if(t.kind==="method"&&(a=e.find(r)))if(g(t.descriptor)||g(a.descriptor)){if(c(t)||c(a))throw new ReferenceError("Duplicated methods ("+t.key+") can't be decorated.");a.descriptor=t.descriptor}else{if(c(t)){if(c(a))throw new ReferenceError("Decorators can't be placed on different accessors with for the same property ("+t.key+").");a.decorators=t.decorators}O(t,a)}else e.push(t)}return e}function c(i){return i.decorators&&i.decorators.length}function g(i){return i!==void 0&&!(i.value===void 0&&i.writable===void 0)}function b(i,e){var r=i[e];if(r!==void 0&&typeof r!="function")throw new TypeError("Expected '"+e+"' to be a function");return r}function k(i){var e=$(i,"string");return typeof e=="symbol"?e:String(e)}function $(i,e){if(typeof i!="object"||i===null)return i;var r=i[Symbol.toPrimitive];if(r!==void 0){var n=r.call(i,e||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(i)}function x(i){return z(i)||I(i)||_(i)||A()}function A(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function _(i,e){if(!i)return;if(typeof i=="string")return w(i,e);var r=Object.prototype.toString.call(i).slice(8,-1);if(r==="Object"&&i.constructor&&(r=i.constructor.name),r==="Map"||r==="Set")return Array.from(i);if(r==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return w(i,e)}function w(i,e){(e==null||e>i.length)&&(e=i.length);for(var r=0,n=new Array(e);r<e;r++)n[r]=i[r];return n}function I(i){if(typeof Symbol!="undefined"&&Symbol.iterator in Object(i))return Array.from(i)}function z(i){if(Array.isArray(i))return i}function u(i,e,r){return typeof Reflect!="undefined"&&Reflect.get?u=Reflect.get:u=function(t,a,s){var o=R(t,a);if(!o)return;var l=Object.getOwnPropertyDescriptor(o,a);return l.get?l.get.call(s):l.value},u(i,e,r||i)}function R(i,e){for(;!Object.prototype.hasOwnProperty.call(i,e)&&!(i=f(i),i===null););return i}function f(i){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(r){return r.__proto__||Object.getPrototypeOf(r)},f(i)}import{LitElement as U,html as m,unsafeCSS as K,query as E,property as h}from"../../../../web_modules/lit-element.js";import{ImageCheckedOutIcon as F,MovieCameraIcon as L,VideoCheckedOutIcon as q,UndoIcon as j,MoveLeftRightIcon as V,FolderOpenIcon as M}from"../../../../web_modules/@spectrum-web-components/icons-workflow.js";import W from"./styles.js";import{create as B}from"../../../renderer/index.js";import{loadImage as H,openFile as P}from"../../../utils.js";import{MimeTypes as N}from"../../../types.js";import"../PaletteEditor/index.js";import"../ImageComparison/index.js";const C=[{name:"Pixelate.pixelSize",min:1,max:15,step:1,value:1,label:"Pixel Size",variant:"ramp"},{name:"Transform.contrast",min:-1,max:1,step:.01,value:0,label:"Contrast"},{name:"Transform.brightness",min:-1,max:1,step:.01,value:0,label:"Brightness"},{name:"Transform.temperature",min:-1,max:1,step:.01,value:0,label:"Temperature"},{name:"Transform.hue",min:-1,max:1,step:.01,value:0,label:"Hue"},{name:"Transform.saturation",min:0,max:2,step:.01,value:1,label:"Saturation"},{name:"Transform.vibrance",min:-1,max:1,step:.01,value:0,label:"Vibrance"},{name:"Transform.sharpen",min:-2,max:2,step:.01,value:0,label:"Unsharp mask"},{name:"Transform.sharpenRadius",min:0,max:10,step:.1,value:1,label:"Unsharp mask size",variant:"ramp"},{name:"Palette.ditherThreshold",min:0,max:1,step:.01,value:0,label:"Dither"},{name:"Palette.ditherSize",min:0,max:15,step:1,value:1,label:"Dither size",variant:"ramp"},{name:"Sobel.threshold",min:0,max:1,step:.001,value:.3,label:"Edge threshold"},{name:"Sobel.size",min:1,max:15,step:1,value:1,label:"Edge size",variant:"ramp"},{name:"Sobel.multiplier",min:-1,max:1,step:.01,value:0,label:"Edge multiplier"}];let G=S(null,function(i,e){class r extends e{constructor(...n){super(...n);i(this)}}return{F:r,d:[{kind:"field",decorators:[E("#canvas")],key:"canvas",value:void 0},{kind:"field",decorators:[h({type:String,attribute:"image-src"})],key:"imageSrc",value(){return""}},{kind:"field",key:"video",value:void 0},{kind:"field",decorators:[E("pis-palette-editor")],key:"paletteEditor",value:void 0},{kind:"field",key:"renderer",value:void 0},{kind:"field",decorators:[h({type:Object,attribute:!1})],key:"knobs",value(){return{}}},{kind:"field",decorators:[h({type:Boolean})],key:"imageComparison",value(){return!1}},{kind:"field",decorators:[h({type:String})],key:"currentPanelTab",value(){return"adjust"}},{kind:"get",static:!0,key:"styles",value:function(){return K(W)}},{kind:"method",key:"firstUpdated",value:function(){const t={};this.renderer=B(this.canvas),this.renderer.filters.forEach(a=>{const s=a.name;for(const o of Object.keys(a.parameters))t[`${s}.${o}`]=a.parameters[o]}),this.knobs=t}},{kind:"method",key:"clear",value:function(){const{video:t,imageSrc:a}=this;a&&a.startsWith("blob:")&&URL.revokeObjectURL(a),t&&(t.srcObject&&t.srcObject.getTracks().forEach(s=>s.stop()),t.src&&t.src.startsWith("blob:")&&URL.revokeObjectURL(t.src)),this.video=null,this.imageSrc=null}},{kind:"method",key:"handleOpenImage",value:function(){this.clear(),P().then(t=>{this.imageSrc=URL.createObjectURL(t)})}},{kind:"method",key:"handleOpenCamera",value:function(){this.clear(),navigator.mediaDevices.getUserMedia({video:!0}).then(t=>{const a=this.video=document.createElement("video");a.srcObject=t,a.play().then(()=>{a.width=a.videoWidth,a.height=a.videoHeight,this.renderer.setSource(a);const s=()=>{this.renderer.draw(),this.video&&requestAnimationFrame(s)};requestAnimationFrame(s)})},console.error)}},{kind:"method",key:"handleOpenVideo",value:function(){this.clear(),P(N.Video).then(t=>{const a=this.video=document.createElement("video");a.src=URL.createObjectURL(t),a.play().then(()=>{a.width=a.videoWidth,a.height=a.videoHeight,this.renderer.setSource(a);const s=()=>{this.renderer.draw(),this.video&&requestAnimationFrame(s)};requestAnimationFrame(s)}),a.onended=a.play.bind(a)})}},{kind:"method",key:"handleKnobChange",value:function(t){return({target:{value:a}})=>{this.setKnob(t,a)}}},{kind:"method",key:"handlePaletteChange",value:function(){const t=this.paletteEditor.palette;t&&t.length?(console.log(new ImageData(new Uint8ClampedArray(t.flat()),t.length,1)),this.renderer.filters.Palette.setPalette(new ImageData(new Uint8ClampedArray(t.flat()),t.length,1))):this.renderer.filters.Palette.setPalette(null),this.setKnob("Palette.ditherThreshold",t?1/t.length:0)}},{kind:"method",key:"update",value:function(t){u(f(r.prototype),"update",this).call(this,t),t.has("imageSrc")&&t.get("imageSrc")!==this.imageSrc&&H(this.imageSrc).then(a=>{this.renderer.setSource(a),this.paletteEditor.image=a}),this.renderer&&t.has("knobs")&&this.renderer.draw()}},{kind:"method",key:"handleResetFiltersClick",value:function(){for(const t of C)this.setKnob(t.name,t.value)}},{kind:"method",key:"toggleImageComparison",value:function(){this.imageComparison=!this.imageComparison}},{kind:"method",key:"setKnob",value:function(t,a){this.knobs={...this.knobs,[t]:a};const[s,o]=t.split(".");this.renderer.filters[s].parameters[o]=a}},{kind:"method",key:"renderKnobs",value:function(){return m`
            <form class="panel-group" .hidden=${this.currentPanelTab!=="adjust"}>
                ${C.map(t=>m`
                        <sp-slider
                            @input=${this.handleKnobChange(t.name)}
                            name="${t.name}"
                            min="${t.min}"
                            max="${t.max}"
                            step="${t.step}"
                            value="${this.knobs[t.name]}"
                            variant="${t.variant||"filled"}"
                            label="${t.label}"
                        ></sp-slider>
                    `)}
            </form>
        `}},{kind:"method",key:"renderPalette",value:function(){return m`
            <div class="panel-group" .hidden=${this.currentPanelTab!=="palette"}>
                <pis-palette-editor @change="${this.handlePaletteChange}"></pis-palette-editor>
            </div>
        `}},{kind:"method",key:"handlePanelTabChange",value:function(t){this.currentPanelTab=t.target.selected}},{kind:"method",key:"render",value:function(){return m`
            <div id="menuBar"></div>

            <div id="leftSidebar" class="scrollable sidebar">
                <sp-action-menu>
                    <sp-icon slot="icon">${M()}</sp-icon>
                    <!-- <span slot="label">Open</span> -->
                    <sp-menu>
                        <sp-menu-item @click="${this.handleOpenImage}">
                            <sp-icon slot="icon">${F()}</sp-icon>Image
                        </sp-menu-item>
                        <sp-menu-item>
                            <sp-icon slot="icon">${q()}</sp-icon>Video
                        </sp-menu-item>
                        <sp-menu-item @click="${this.handleOpenCamera}">
                            <sp-icon slot="icon">${L()}</sp-icon>Camera
                        </sp-menu-item>
                    </sp-menu>
                </sp-action-menu>

                <sp-action-button quiet @click="${this.handleResetFiltersClick}">
                    <sp-icon slot="icon">${j()}</sp-icon>
                </sp-action-button>

                <sp-rule size="small"></sp-rule>

                <sp-action-button
                    quiet
                    toggles
                    .selected=${this.imageComparison}
                    @click="${this.toggleImageComparison}"
                >
                    <sp-icon slot="icon">${V()}</sp-icon>
                </sp-action-button>
            </div>

            <div id="main">
                <pis-image-comparison .enable="${this.imageComparison}">
                    <img slot="original" src="${this.imageSrc}" />
                    <canvas slot="modified" id="canvas"></canvas>
                </pis-image-comparison>
            </div>

            <div id="rightPanel" class="scrollable">
                <sp-tabs
                    selected="${this.currentPanelTab}"
                    @change=${this.handlePanelTabChange}
                    quiet
                >
                    <sp-tab label="Adjust" value="adjust"></sp-tab>
                    <sp-tab label="Palette" value="palette"></sp-tab>
                </sp-tabs>

                ${this.renderKnobs()} ${this.renderPalette()}
            </div>

            <sp-icons-medium></sp-icons-medium>
            <sp-icons-workflow></sp-icons-workflow>
        `}}]}},U);customElements.define("pis-app",G);
